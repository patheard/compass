{% extends "base.html" %}

{% block content %}
<gcds-heading tag="h1">{{ assessment.product_name | markdown_no_tags }}</gcds-heading>


<div class="assessment-progress-bar">
    {% for status in assessment_statuses %}
        {% set current_index = assessment_statuses.index(assessment.status) %}
        {% set status_index = loop.index0 %}
        {% if status_index < current_index %}
            {% set status_class = 'complete' %}
        {% elif status_index == current_index %}
            {% set status_class = 'active' %}
        {% else %}
            {% set status_class = 'pending' %}
        {% endif %}
        <div class="progress-step {{ status_class }} cursor-help" title="{{ _(status + '_status_description') }}">
            <div class="progress-circle">
                {% if status_class == 'complete' %}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="{{ _('Complete') }}">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                {% else %}
                {{ status_index + 1 }}
                {% endif %}
            </div>
            <div class="progress-label">{{ _(status|capitalize) }}</div>
        </div>
        {% if not loop.last %}
            <div class="progress-line {{ 'complete' if status_index < current_index else 'pending' }}"></div>
        {% endif %}
    {% endfor %}
</div>
<gcds-text>
    {{ _('Assessment is on the') }} <code>{{ _(assessment.status|capitalize) }}</code> {{ _('step of the') }} <gcds-link href="https://docs.google.com/document/d/1IEOR7mDjfkkVN-mJIdLOZBoALR6slXQFSErxI43EYSg" target="_blank">{{ _('Agile SA&A process') }}</gcds-link>.
</gcds-text>


<nav class="tabs mt-700" aria-label="Guidance tabs" data-tabs>
    <ul>
        <li class="tab"><a href="#overview" data-tab-link aria-current="page"><span class="text">{{ _('Overview') }}</span></a></li>
        <li class="tab"><a href="#controls" data-tab-link><span class="text">{{ _('Controls') }}</span> <span class="count">{{ controls|length }}</span></a></li>
        {% if assessment.aws_account_id %}
        <li class="tab"><a href="#aws-resources" data-tab-link><span class="text">{{ _('AWS resources') }}</span></a></li>
        {% endif %}
    </ul>
</nav>

<div id="overview" data-tab-panel>
    <gcds-heading tag="h2">{{ _('Overview') }}</gcds-heading>
    <gcds-text>
        {{ assessment.product_description | markdown }}
    </gcds-text>

    <gcds-button href="/assessments/{{ assessment.assessment_id }}/edit" type="link" button-role="primary" class="mt-600">
        {{ _("Edit") }}
    </gcds-button>
    <gcds-button href="/assessments/{{ assessment.assessment_id }}/delete" type="link" button-role="secondary" data-csrf-token="{{ csrf_token }}" class="delete-item">
        {{ _("Delete") }}
    </gcds-button>
</div>

<div id="controls" data-tab-panel hidden>
    <gcds-heading tag="h2">
        {{ 'Controls' }}{% if controls %}: {{ controls|length }}{% endif %}
    </gcds-heading>

    {% if controls %}
    {% set control_status_counts = dict.fromkeys(control_statuses, 0) %}
    {% for control in controls %}
        {% if control.status in control_status_counts %}
            {% set _ = control_status_counts.update({control.status: control_status_counts[control.status] + 1}) %}
        {% endif %}
    {% endfor %}
    
    <gcds-grid columns-desktop="2fr 1fr" columns-tablet="1fr 1fr" columns="1fr" class="mb-600">
        <section>
            <gcds-heading tag="h3">{{ control_status_counts.compliant }} {{ _('of') }} {{ controls|length }} {{ _('controls compliant') }}</gcds-heading>
        </section>
        <section>
            <canvas class="compliance-chart"
                {% for status, count in control_status_counts.items() %}
                data-{{ status }}="{{ count }}"
                {% endfor %}
                aria-label="{{ _('Controls compliance chart') }}"
                role="img">
            </canvas>
        </section>
    </gcds-grid>

    <section class="table-container mb-600">
        <table>
            <thead>
                <tr>
                    <th class="w-10">{{ _('ID') }}</th>
                    <th>{{ _('Title') }}</th>
                    <th class="w-10">{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for control in controls %}
                    <tr>
                        <td class="nowrap">
                            <div class="d-flex align-content-start">
                                <abbr title="{{ _(control.status) }}" class="icon me-150">
                                    {% if control.status == 'compliant' %}✅
                                    {% elif control.status == 'partially_compliant' %}⚠️
                                    {% elif control.status == 'non_compliant' %}❌
                                    {% else %}➖
                                    {% endif %}
                                </abbr>
                                <span class="content">
                                    <gcds-link href="/assessments/{{ assessment.assessment_id }}/controls/{{ control.control_id }}">{{ control.nist_control_id }}</gcds-link>
                                </span>
                            </div>
                        </td>
                        <td>{{ control.control_title | markdown_no_tags | truncate(100) }}</td>
                        <td class="nowrap actions">
                            <gcds-link href="/assessments/{{ assessment.assessment_id }}/controls/{{ control.control_id }}/edit"><img src="/static/img/edit.svg" title="{{ _('Edit') }}" alt="{{ _('Edit') }}"></gcds-link>
                            <gcds-link href="/assessments/{{ assessment.assessment_id }}/controls/{{ control.control_id }}/delete" data-csrf-token="{{ csrf_token }}" class="delete-item"><img src="/static/img/delete.svg" title="{{ _('Delete') }}" alt="{{ _('Delete') }}"></gcds-link>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <gcds-button href="/assessments/{{ assessment.assessment_id }}/controls/new" type="link">
        {{ _('Add') }}
    </gcds-button>
    {% else %}
    <gcds-notice type="info" notice-title-tag="h2" notice-title="Nothing found">
      <gcds-text>
        {{ _('Get started by') }} <gcds-link href="/assessments/{{ assessment.assessment_id }}/controls/new">{{ _('creating a control') }}</gcds-link> {{ _('or') }} <gcds-link href="/assessments/{{ assessment.assessment_id }}/import">{{ _('importing from GitHub') }}</gcds-link>.
      </gcds-text>
    </gcds-notice>
    {% endif %}
</div>

{% if assessment.aws_account_id %}
<div id="aws-resources" data-tab-panel hidden>
    <gcds-heading tag="h2">{{ _('AWS resources') }}</gcds-heading>
    <gcds-text>
        {{ assessment.product_name | markdown_no_tags }} {{ _('runs in AWS account ID') }} <code>{{ assessment.aws_account_id }}</code>
        {% if assessment.aws_resources %}
            {{ _('using the following services:') }}
        {% endif %}
    </gcds-text>

    {% if assessment.aws_resources %}
    <div class="autocomplete-badges">
        {% for resource in assessment.aws_resources | sort_by_locale %}
        <span class="autocomplete-badge">
            {{ _(resource) }}
        </span>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<script src="/static/js/chart.js"></script>
<script src="/static/js/tabs.js"></script>

{% endblock %}